# Lecture Slides Extractor

Автоматическое извлечение слайдов из видео лекций и создание структурированного Markdown-документа с транскриптом.

## Описание

Приложение анализирует видео лекции, где лектор в углу, а основную площадь занимают статические слайды. Программа:
- Детектирует смену слайдов
- Извлекает уникальные слайды
- Сопоставляет их с текстом из транскрипта
- Создает Markdown-документ с изображениями и текстом

## Требования

- Python 3.10+
- macOS (оптимизировано для Apple Silicon M3)
- Видеофайл лекции
- Транскрипт с таймкодами

## Установка

1. Клонируйте репозиторий или скачайте файлы
2. Установите зависимости:

```bash
pip install -r requirements.txt
```

## Формат транскрипта

Транскрипт должен быть в текстовом файле с форматом:

```
|(MM:SS - MM:SS)
|Текст, который говорит лектор в этом временном интервале
|
|(MM:SS - MM:SS)
|Следующий сегмент текста...
```

Пример:

```
|(0:02 - 0:22)
|Привет! Сегодня мы будем говорить про понимание бизнес-задачи.
|
|(0:22 - 0:39)
|Потому что это на самом деле то, что напрямую нас к исследованию приводит.
```

## Использование

### Базовая команда

```bash
python src/main.py --video lecture.mp4 --transcript transcript.txt --output result.md
```

### С дополнительными параметрами

```bash
python src/main.py \
  --video lecture.mp4 \
  --transcript transcript.txt \
  --output result.md \
  --slides-dir slides/ \
  --sample-rate 1.0 \
  --threshold 0.92
```

### Обработка папки с видео и транскриптом

Если у вас есть папка с видео и транскриптом, используйте `auto_process.py`:

```bash
python3 auto_process.py "путь/к/папке" --force
```

Скрипт автоматически найдет видео и транскрипт в папке и обработает их.

## Параметры

- `--video` - Путь к видеофайлу (обязательный)
- `--transcript` - Путь к файлу транскрипта (обязательный)
- `--output` - Путь к выходному Markdown файлу (по умолчанию: output.md)
- `--slides-dir` - Папка для сохранения изображений слайдов (по умолчанию: slides/)
- `--sample-rate` - Частота анализа кадров в секундах (по умолчанию: 1.0)
- `--threshold` - Порог чувствительности для детектирования смены слайдов (0-1, по умолчанию: 0.92)
- `--crop-region` - Область для анализа (bottom_left, bottom_right, top_right, top_left, center). Если не указано, будет предложен интерактивный выбор (по умолчанию: bottom_left)

## Как это работает

1. **Выбор области анализа**: При запуске программа предлагает выбрать область кадра для анализа (где НЕТ лектора):
   - Левый нижний угол (30%) - по умолчанию
   - Правый нижний угол (30%)
   - Правый верхний угол (30%)
   - Левый верхний угол (30%)
   - Центр (50%)
2. **Анализ видео**: Программа извлекает кадры из видео с заданной частотой (по умолчанию каждую секунду)
3. **Обрезка для анализа**: Анализируется выбранная область кадра для исключения лектора
4. **Сохранение**: Сохраняются **полные кадры** слайдов (не обрезанные)
5. **Детектирование**: Сравнение соседних кадров через комбинированную метрику:
   - SSIM (Structural Similarity Index) с размытием для уменьшения влияния шума
   - Процент совпадающих пикселей с допуском (игнорирует мелкие различия)
6. **Фильтрация**: Удаление дубликатов с учетом минимальной длительности слайда (30 секунд)
7. **Сопоставление**: Пропорциональное распределение текста из транскрипта между слайдами без дублирования
8. **Генерация**: Создание Markdown файла с полными изображениями слайдов и соответствующим текстом

## Пример выходного файла

```markdown
# Лекция

## Слайд 1 (0:02)
![Слайд 1](<./slides/slide_001.png>)

Привет! Сегодня мы будем говорить про понимание бизнес-задачи...

---

## Слайд 2 (0:22)
![Слайд 2](<./slides/slide_002.png>)

Потому что это на самом деле то, что напрямую нас к исследованию приводит...
```

**Примечание**: Пути к изображениям используют угловые скобки `<>` для корректной работы с пробелами в именах файлов.

## Оптимизация производительности

Для быстрой обработки больших видео:
- Увеличьте `--sample-rate` до 2-3 секунд (меньше точность, выше скорость)

Для максимальной точности:
- Уменьшите `--sample-rate` до 0.5 секунд (ловит быстрые переключения слайдов)
- Увеличьте `--threshold` до 0.95 (более строгое сравнение)

**Примечание**: Область анализа выбирается интерактивно при запуске или через параметр `--crop-region`. По умолчанию используется левый нижний угол (30%).

## Устранение неполадок

**Слишком много слайдов детектируется**: 
- Увеличьте `--threshold` до 0.95 (более строгое сравнение)
- Выберите другую область анализа (где точно нет лектора)

**Пропускаются слайды**: 
- Уменьшите `--threshold` до 0.90 (менее строгое сравнение)
- Уменьшите `--sample-rate` до 0.5 секунд (чаще анализирует кадры)
- Убедитесь, что выбранная область анализа не содержит лектора

**Текст дублируется между слайдами**: 
- Это исправлено! Текст теперь распределяется пропорционально без дублирования

**Текст теряется**: 
- Программа собирает весь текст из транскрипта, включая текст после пустых строк внутри сегментов
- Текст распределяется пропорционально времени между слайдами

## Особенности реализации

### Алгоритм детектирования слайдов

- **Область анализа**: Выбирается пользователем при запуске:
  - Угловые области: 30% ширины × 30% высоты (левый/правый нижний/верхний углы)
  - Центральная область: 50% ширины × 50% высоты (центр кадра)
  - По умолчанию: левый нижний угол (30%)
- **Метрика сравнения**: Комбинированная метрика SSIM + процент совпадающих пикселей с допуском
- **Размытие**: Применяется GaussianBlur (5×5) для уменьшения влияния шума и артефактов сжатия
- **Минимальная длительность**: 30 секунд между слайдами для фильтрации ложных срабатываний

### Распределение текста

- **Пропорциональное распределение**: Текст из больших интервалов транскрипта распределяется пропорционально времени между слайдами
- **Без дублирования**: Каждая часть текста попадает только к одному слайду
- **Разбиение по предложениям**: Текст разбивается на предложения и распределяется пропорционально временным отрезкам

### Формат транскрипта

- Поддерживаются пустые строки внутри сегментов (текст собирается полностью)
- Формат: `(MM:SS - MM:SS)` или `(H:MM:SS - H:MM:SS)`
- Текст может быть разбит на несколько строк внутри одного временного интервала

## Будущие улучшения

- GUI интерфейс с drag-and-drop
- Поддержка SRT файлов
- Автоматическое определение области без лектора
- Предпросмотр результатов
- Экспорт в PDF/HTML

## Лицензия

Разработано для AI Lab

