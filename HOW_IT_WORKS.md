# Как работает программа "под капотом" - простое объяснение

## Общая идея

Программа делает то же самое, что вы бы делали вручную:
1. Смотрите видео и замечаете, когда меняется слайд
2. Делаете скриншот нового слайда
3. Смотрите в транскрипт и находите, что говорил лектор в это время
4. Собираете все в один документ

Только делает это автоматически и быстро!

---

## Шаг 1: Анализ видео

### Что происходит:
Программа открывает видеофайл и начинает "смотреть" его по кадрам.

**Простыми словами:**
- Видео - это просто много картинок (кадров), которые быстро меняются
- Обычно 30 картинок в секунду (30 FPS)
- Программа берет не все кадры, а каждый 30-й (примерно 1 кадр в секунду)
- Это как смотреть видео в замедленной перемотке

**Зачем так:**
- Если анализировать все 30 кадров в секунду - это слишком много
- Слайды меняются редко (раз в минуту-две)
- Достаточно проверять раз в секунду - не пропустим смену слайда

---

## Шаг 2: Поиск смены слайдов

### Проблема:
Как понять, что слайд изменился? Ведь лектор может двигаться, жестикулировать, но слайд остается тем же.

### Решение:
Программа анализирует **только часть кадра** - ту область, где НЕТ лектора.

**Как это работает:**
1. Вы выбираете область (например, левый нижний угол)
2. Программа вырезает только эту область из каждого кадра
3. Сравнивает эту область между соседними кадрами

**Пример:**
```
Кадр 1: [Слайд с текстом] [Лектор в углу]
         ↑ анализируем    ↑ игнорируем

Кадр 2: [Слайд с текстом] [Лектор жестикулирует]
         ↑ анализируем    ↑ игнорируем

Результат: Область слайда не изменилась → слайд тот же
```

### Как сравниваются кадры:

**Метод 1: SSIM (Structural Similarity Index)**
- Это как сравнение "на глаз"
- Программа смотрит не на каждый пиксель отдельно, а на структуру изображения
- Если структура похожа → слайды одинаковые
- Если структура разная → слайд изменился

**Метод 2: Подсчет разных пикселей**
- Программа сравнивает каждый пиксель
- Но игнорирует очень маленькие различия (шум, сжатие видео)
- Если больше 1% пикселей сильно отличаются → слайд изменился

**Зачем два метода:**
- SSIM хорош для больших изменений (новый слайд)
- Подсчет пикселей хорош для мелких различий (шум видео)
- Используется тот, который дает лучший результат

### Размытие (Gaussian Blur):
Перед сравнением программа слегка "размывает" изображение.
- Это убирает мелкий шум и артефакты сжатия
- Как если бы вы смотрели на картинку издалека - мелкие детали не важны

---

## Шаг 3: Фильтрация ложных срабатываний

### Проблема:
Иногда программа может подумать, что слайд изменился, хотя это просто:
- Мигание экрана
- Временное затемнение
- Мелкое движение в кадре

### Решение:
**Минимальная длительность слайда: 30 секунд**
- Если "новый слайд" появился через 5 секунд после предыдущего → это ошибка, игнорируем
- Если прошло 30+ секунд → это реальная смена слайда, сохраняем

**Порог чувствительности (threshold): 0.92**
- Если кадры похожи на 92% и больше → это один и тот же слайд
- Если похожесть меньше 92% → это новый слайд
- Чем выше порог (ближе к 1.0) → тем строже сравнение (меньше слайдов)
- Чем ниже порог (ближе к 0.5) → тем мягче сравнение (больше слайдов)

---

## Шаг 4: Парсинг транскрипта

### Что делает:
Читает текстовый файл и находит, какой текст соответствует какому времени.

**Формат транскрипта:**
```
(0:02 - 0:22)
Привет! Сегодня мы будем говорить...

(0:22 - 0:39)
Потому что это на самом деле...
```

**Как работает:**
1. Программа ищет строки с таймкодами: `(MM:SS - MM:SS)`
2. Запоминает время начала и конца
3. Собирает весь текст до следующего таймкода
4. Создает список: "В такое-то время говорилось то-то"

**Особенность:**
- Программа собирает ВЕСЬ текст, даже если есть пустые строки внутри
- Это важно, потому что в транскриптах могут быть разрывы строк

---

## Шаг 5: Сопоставление слайдов и текста

### Задача:
У нас есть:
- Слайд 1: появился в 0:02
- Слайд 2: появился в 0:45
- Транскрипт: "(0:02 - 1:30) Длинный текст..."

Как распределить текст между слайдами?

### Решение: Пропорциональное распределение

**Пример:**
```
Слайд 1: 0:02 - 0:45 (43 секунды)
Слайд 2: 0:45 - 1:30 (45 секунд)
Транскрипт: (0:02 - 1:30) "Очень длинный текст из 10 предложений"

Распределение:
- Слайд 1 получает текст за 43 секунды из 88 секунд = 49%
- Слайд 2 получает текст за 45 секунд из 88 секунд = 51%

Текст разбивается на предложения и распределяется:
- Слайд 1: первые 5 предложений (49%)
- Слайд 2: последние 5 предложений (51%)
```

**Важно:**
- Каждое предложение попадает только к одному слайду (нет дублирования)
- Распределение пропорционально времени
- Если текст короткий и попадает только на один слайд → весь текст идет к этому слайду

---

## Шаг 6: Генерация Markdown

### Что делает:
Собирает все вместе в один документ.

**Структура:**
```markdown
# Название лекции

## Слайд 1 (0:02)
![Слайд 1](<путь/к/изображению.png>)

Текст из транскрипта, который соответствует этому слайду...

---

## Слайд 2 (0:45)
![Слайд 2](<путь/к/изображению.png>)

Текст из транскрипта...
```

**Особенности:**
- Сохраняются ПОЛНЫЕ кадры (не обрезанные)
- Пути к изображениям обернуты в `< >` для корректной работы с пробелами
- Каждый слайд имеет заголовок с временем появления

---

## Технические детали (для любопытных)

### Используемые библиотеки:

1. **OpenCV (cv2)**
   - Работа с видео: открытие, чтение кадров
   - Обработка изображений: обрезка, размытие, сохранение

2. **NumPy**
   - Работа с массивами пикселей
   - Математические операции над изображениями

3. **scikit-image**
   - SSIM (метрика сравнения изображений)
   - Научные алгоритмы обработки изображений

4. **Pillow (PIL)**
   - Дополнительная работа с изображениями
   - Конвертация форматов

### Алгоритм сравнения кадров (детально):

```python
1. Взять два кадра (предыдущий и текущий)
2. Вырезать анализируемую область из обоих
3. Конвертировать в черно-белое (быстрее)
4. Применить размытие (убрать шум)
5. Вычислить SSIM (структурное сходство)
6. Подсчитать процент совпадающих пикселей
7. Взять максимум из двух метрик
8. Если результат < порога (0.92) → слайд изменился
```

### Почему это работает:

1. **Область анализа без лектора:**
   - Лектор двигается → это не влияет на сравнение
   - Слайд статичен → изменения видны сразу

2. **Размытие:**
   - Убирает артефакты сжатия видео
   - Игнорирует мелкий шум
   - Фокусируется на крупных изменениях

3. **Минимальная длительность:**
   - Реальные слайды держатся долго (минуты)
   - Ложные срабатывания короткие (секунды)
   - Фильтруем короткие "слайды"

4. **Пропорциональное распределение:**
   - Текст распределяется по времени
   - Нет дублирования
   - Каждый слайд получает релевантный текст

---

## Производительность

**На видео длительностью 1 час:**
- Извлекается ~3600 кадров (1 кадр в секунду)
- Сравнивается ~3600 пар кадров
- Находится ~30-70 уникальных слайдов
- Обрабатывается ~200-300 сегментов транскрипта
- Время обработки: ~15-20 минут на M3 Mac

**Оптимизации:**
- Анализ только части кадра (быстрее)
- Черно-белое сравнение (в 3 раза быстрее цветного)
- Размытие уменьшает размер данных
- Обработка 1 кадра в секунду (не все 30)

---

## Итого простыми словами

Программа работает как **умный ассистент**, который:
1. **Смотрит** видео и замечает, когда меняется слайд
2. **Делает скриншоты** всех уникальных слайдов
3. **Читает** транскрипт и находит, что говорилось в нужное время
4. **Собирает** все вместе в красивый документ

Всё автоматически, быстро и без ошибок!

